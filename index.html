<!DOCTYPE html>
<!--
This code was copied from https://github.com/twitter/twitter.github.com/blob/master/index.html and adapted for Symphony Software Foundation needs
-->
<html>
  <head>
    <title>Symphony Software Foundation</title>
    <link rel="stylesheet" type="text/css" href="assets/reset.css">
    <link rel="stylesheet" type="text/css" href="assets/grid.css">
    <link rel="stylesheet" type="text/css" href="assets/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Documentation for projects hosted by the Foundation.">
  </head>
  <body>
    <div id="wrapper" class="grid clearfix">
      <div id="main" class="grid-1">
        <div id="logo"><h1>Symphony Software Foundation</h1></div>
        <h1>Documentation for projects hosted by the Foundation.</h1>
        <p>Want to join? <a href="https://symphonyoss.atlassian.net/wiki/display/FM/Contribution">Become a Contributor</a></p>
        <p>More about <a href="https://symphony.foundation/">Symphony Software Foundation</a></p>
        <p>&nbsp;</p>
        <p>More about the Foundation:
        <br/><a href="https://twitter.com/symphonyOSS">Twitter</a>, <a href="http://linkedin.com/company/symphony-software-foundation">LinkedIN</a> and <a href="http://facebook.com/symphonyOSS">Facebook</a></p>
      </div>

      <div id="filter-container" class="grid grid-3">
<!--         <div id="statistics" class="grid-1 alpha header">
          <h1>Statistics</h1>
          <p>
            <a href="https://symphonyoss.biterg.io/app/kibana#/dashboard/Overview?_g=()"><span id="num-projects"><img src="assets/spinner.gif" /></span> public projects</a>
          </p>
          <p>
            <a href="https://github.com/symphonyoss/repositories"><span id="num-repos"><img src="assets/spinner.gif" /></span> public repos</a>
          </p>
          <p class="email"><a href="mailto:info@symphony.foundation">info@symphony.foundation</a></p>
        </div>
 -->
        <!-- <div id="recently-updated" class="grid-2 omega header">
          <h1>Recently updated <a href="https://github.com/symphonyoss/repositories">View All on GitHub</a></h1>
          <ol id="recently-updated-repos"></ol>
        </div> -->
      </div>

      <ol id="repos"></ol>

    </div>
    <script type="text/javascript">

  var _gaq = _gaq || [];
  // TODO - enable it when ready
  //_gaq.push(['_setAccount', 'UA-89349362-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

    </script>
    <script type="text/javascript" src="assets/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="assets/strftime.js"></script>
    <script type="text/javascript">
    (function ($, undefined) {

      var repos = []

      //List of filter fields
      var filterFields = ['language','projectState'];

      // Put custom repo URL's in this object, keyed by repo name.
      var repoUrls = {
        "symphony-java-client": "http://symphonyoss.github.io/symphony-java-client/",
        "symphony-java-sample-bots": "http://symphonyoss.github.io/symphony-java-sample-bots/",
        "ssf-parent-pom": "http://symphonyoss.github.io/ssf-parent-pom/",
        "clj-symphony": "https://symphonyoss.github.io/clj-symphony/"
      };

      var filterNameLabels = {
        "projectState": "Project State",
        "language": "Language"
      };

      var filterValueLabels = {
        "projectState" : {
          "INCUBATING": "Incubating",
          "RELEASED": "Released",
          "ARCHIVED": "Archived"
        }
      };

      // Put custom repo descriptions in this object, keyed by repo name.
      var repoDescriptions = {
        "naggati2": "A protocol builder for Netty using Scala 2.8"
      };

      function fetchAllRepos(page) {
        page = page || 1;

        //Mocked URI
        //var uri = "gh-repos-mock"+page+".json";
        var uri = "https://api.github.com/orgs/symphonyoss/repos?"
                + "per_page=100"
                + "&page="+page;

        $().ready(function () {
          $.get(uri, function (result) {
            //Mocked URI
            if (result && result.length > 0) {
            // if (result.data && result.data.length > 0) {
              //Mocked URI
              repos = repos.concat(result);
              // repos = repos.concat(result.data);
              fetchAllRepos(page + 1);
            }
            else {
              $(function () {
                enrichRepos(repos,true);
              });
            }
          });
        });
      }

      function enrichRepos(repos, createFilters) {
        var projects = []
        $().ready(function () {
          $.get("projects.json", function (ssfProjects) {
            $.each( ssfProjects, function( projectName, projectInfo ) {
              var project = {}
              project['name'] = projectName;
              project['repos'] = []
              $.each( projectInfo, function( repoIdx, ssfRepo ) {
                var newRepo = repos.filter(function(ghRepo) {
                  return ghRepo['name'] == ssfRepo['repositoryName']
                })[0];
                project['repos'].push($.extend(newRepo, ssfRepo));
              });
              projects.push(project);
            });
            if (createFilters) {
              renderFilters(projects);
              renderSorts(projects);
            }
            renderProjects(projects);
          })
        });
      }

      function renderSorts(projects) {
        if (!$( "#sort").length) {
          var $div = $("<div>").attr("id","sort").addClass("grid-3 omega header");
          var $h1 = $("<h1>").text("Sort By");
          $div.append($h1);
          $div.appendTo("#filter-container");
        }

        if (!$("#sort-by-name").length) {
          var $p = $("<p>").attr("id","sort-by-name").attr("style","display:inline");
          var $name = $("<a>").attr("href", "#").text("Name").click(function(){
            toggleSort(this,$("#sort-by-activity > span > a"));
          });
          $p.append($("<span>").addClass("name").append($name));
          $p.appendTo("#sort");
        }

        if (!$("#sort-by-activity").length) {
          var $p = $("<p>").attr("id","sort-by-activity").attr("style","display:inline");
          var $name = $("<a>").attr("href", "#").text("Last activity").click(function(){
            toggleSort(this,$("#sort-by-name > span > a"));
          });
          $p.append($("<span>").addClass("name").append($name));
          $p.appendTo("#sort");
        }

        if (!isFilterSelected($('#sort-by-name > span > a')) && !isFilterSelected($('#sort-by-activity > span > a'))) {
          $('#sort-by-activity > span > a').addClass("selected");
        }
      }

      function renderFilters(projects) {
        $.each(projects, function (i, project) {
          $.each(project['repos'], function (i, repo) {
            // Build the filter mask
            filterFields.forEach (function (filterName) {
              var repoValue = repo[filterName];
              if (repoValue) {
                addRepoFilters(filterName,repoValue);
              }
            });
          });
        });
      }

      function addRepoFilters(filterName, filterValue) {
        if (jQuery.type( filterValue ) === "string") {
          key = filterName+"-"+filterValue.replace('#','-sharp');
        } else {
          key = filterName+"-"+filterValue;
        }
        filterKey = "filter-"+key;
        containerKey = "filtercontainer-"+filterName;

        if (!$( "#"+containerKey ).length) {
          var $div = $("<div>").attr("id",containerKey).addClass("grid-3 omega header");
          var $h1 = $("<h1>").text(filterNameLabel(filterName));
          $div.append($h1);
          $div.appendTo("#filter-container");
        }

        if (!$("#"+filterKey).length) {
          var $p = $("<p>").attr("id",filterKey).attr("style","display:inline");
          var $name = $("<a>").attr("href", "#").text(filterValueLabel(filterName,filterValue)).click(function(){
            toggleFilter(this);
          });
          $p.append($("<span>").addClass("name").append($name));
          $p.appendTo("#"+containerKey);
        }
      }

      function renderProjects(projects) {
        // Reset page
        $("#repos").empty();
        $("#recently-updated-repos").empty();
        $("#num-projects").text(projects.length);

        var filteredProjects = projects.filter(function(project) {
          return filterProject(project);
        });
        
        //TODO
        //$("#num-repos").text(projects.length);

        // TODO - Sorting, not needed right now
        // $.each(filteredReposToRender, function (i, repo) {
        //   repoCalculations(repo);
        // });

        sortResults(filteredProjects);
      }

      // Return true if at least one of the repos matches
      function filterProject(project) {
        var ret = false;
        $.each(project['repos'], function (i, repo) {
          var repo_ret = true;
          filterFields.forEach(function(filterName){
            var repoValue = repo[filterName];
            $('#filtercontainer-'+filterName+' > p > span > a').each(function(i) {
              var filterValue = resolveValueLabel(filterName,$(this).text());
              var isSelected = isFilterSelected($(this));
              if (isSelected && repoValue != filterValue) {
                repo_ret = false;
              }
            });
          });
          if (repo_ret) ret=true;
        });
        // console.log('showing repo '+repo['name']+'? '+ret);
        return ret;
      }

      function addRecentlyUpdatedRepo(repo) {
        var $item = $("<li>");

        var $name = $("<a>").attr("href", repo.html_url).text(repo.name);
        $item.append($("<span>").addClass("name").append($name));

        var $time = $("<a>").attr("href", repo.html_url + "/commits").text(strftime("%h %e, %Y", repo.pushed_at));
        $item.append($("<span>").addClass("time").append($time));

        $item.append('<span class="bullet">&sdot;</span>');

        var $watchers = $("<a>").attr("href", repo.html_url + "/stargazers").text(repo.stargazers_count + " stargazers");
        $item.append($("<span>").addClass("watchers").append($watchers));

        $item.append('<span class="bullet">&sdot;</span>');

        var $forks = $("<a>").attr("href", repo.html_url + "/network").text(repo.forks_count + " forks");
        $item.append($("<span>").addClass("forks").append($forks));

        $item.appendTo("#recently-updated-repos");
      }

      function addRepo(repo) {
        var $item = $("<li>").addClass("repo grid-1 " + (repo.language || '').toLowerCase());
        var $link = $("<a>").attr("href", repoUrl(repo)).appendTo($item);
        $link.append($("<h2>").text(repo.name));
        $link.append($("<h3>").text(repo.language));
        $link.append($("<p>").text(repoDescription(repo)));
        $item.appendTo("#repos");
      }

      function addProject(project) {
        var $item = $("<li>").addClass("repo grid-1");
        $("<h2>").text(project['name']).appendTo($item);

        if (project['repos'].length == 1) {
          repo = project['repos'][0];
          var $a = $("<a>").attr("href", repoUrl(repo));
          $item.append($("<p>").text(repoDescription(repo)));
          $item = $a.append($item);
        } else {
          var $ul = $("<ul>");
          $.each(project['repos'], function (i, repo) {
            var $li = $("<li>");
            var $a = $("<a>").attr("href", repoUrl(repo));
            $a.text(repo['repositoryName']);
            $a.appendTo($li);
            $li.appendTo($ul);
          });
          $ul.appendTo($item);
        }
        $item.appendTo("#repos");
      }

      function isFilterSelected(item) {
        return ($(item).attr("class") && $(item).attr("class").split(' ').indexOf('selected') > -1);
      }

      function toggleFilter(filterLink) {
        // console.log("toggling filter - "+filterName + ":"+filterValue);
        if (isFilterSelected(filterLink)) {
          $(filterLink).removeClass("selected");
        } else {
          $(filterLink).addClass("selected");
        }
        enrichRepos(repos,false);
      }

      function toggleSort(toEnable,toDisable) {
        $(toDisable).removeClass("selected");
        $(toEnable).addClass("selected");
        enrichRepos(repos,false);
      }

      function sortResults(projects) {
        // // Sort by highest # of watchers.
        // projects.sort(function (a, b) {
        //   if (a.hotness < b.hotness) return 1;
        //   if (b.hotness < a.hotness) return -1;
        //   return 0;
        // });

        // Sort by most-recently pushed to.
        var sort_by = "activity";
        if (isFilterSelected($('#sort-by-name > span > a'))) {
          sort_by = "name";
        }
        // if (isFilterSelected($('#sort-by-activity > span > a'))) {
        // }

        if (sort_by == "name") {
          projects.sort(function (a, b) {
            if (a.name.toLowerCase() < b.name.toLowerCase()) return -1;
            if (b.name.toLowerCase() < a.name.toLowerCase()) return 1;
            return 0;
          });
        } else {
          projects.sort(function (a, b) {
            var a_updated = a['repos'].sort(function(a1,b1) {
              return new Date(b1.updated_at).getTime() - new Date(a1.updated_at).getTime() 
            })[0].updated_at;
            var b_updated = b['repos'].sort(function(a1,b1) { 
              return new Date(b1.updated_at).getTime() - new Date(a1.updated_at).getTime() 
            })[0].updated_at;

            if (a_updated < b_updated) return 1;
            if (b_updated < a_updated) return -1;
            return 0;
          });          
        }

        $.each(projects, function (projectIdx, project) {
          addProject(project);
        });
      }

      function repoCalculations(repo) {
        // Convert pushed_at to Date.
        repo.pushed_at = new Date(repo.pushed_at);

        var weekHalfLife  = 1.146 * Math.pow(10, -9);

        var pushDelta    = (new Date) - Date.parse(repo.pushed_at);
        var createdDelta = (new Date) - Date.parse(repo.created_at);

        var weightForPush = 1;
        var weightForWatchers = 1.314 * Math.pow(10, 7);

        repo.hotness = weightForPush * Math.pow(Math.E, -1 * weekHalfLife * pushDelta);
        repo.hotness += weightForWatchers * repo.watchers / createdDelta;
      }

      // Util functions

      function repoUrl(repo) {
        return repoUrls[repo.repositoryName] || repo.html_url || '#';
      }

      function filterNameLabel(filterName) {
        return filterNameLabels[filterName] ? filterNameLabels[filterName] : "Filter by "+filterName;
      }

      function filterValueLabel(filterName,filterValue) {
        return (filterValueLabels[filterName] && filterValueLabels[filterName][filterValue]) ? filterValueLabels[filterName][filterValue] : filterValue;
      }

      function resolveValueLabel(filterName,label) {
        var ret = label;
        if (filterValueLabels[filterName]) {
          $.each(filterValueLabels[filterName],function(filterValue,filterLabel) {
            if (filterLabel === label) {
              ret = filterValue;
            }
          });
        }
        return ret;
      }

      function repoDescription(repo) {
        return repoDescriptions[repo.name] || repo.description || repo.name;
      }

      // Invoke the main function
      fetchAllRepos();
    })(jQuery);
    </script>
  </body>
</html>
